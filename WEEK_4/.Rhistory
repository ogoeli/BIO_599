method = "ML")
str(data_3)
data_3$Treatment <- as.factor(data_3$Treatment)
data_3$Nutrient  <- as.factor(data_3$Nutrient)
table(data_3$Treatment)
table(data_3$Nutrient)
library(nlme)
# Fit GLS with main effects only
gls_model <- gls(Biomass ~ Abundance_c + Treatment + Nutrient,
data = data_3,
method = "ML")
library(tidyverse)
library(nlme)
library(ggResidpanel)
data_1 <- read.csv("trunkfl.csv")
head(data_1)
sub <- data_1 |>
filter(Species == 4)
ggplot(sub, aes(x = TF, y = DBH)) +
geom_point()+
geom_smooth(method = "lm", color = "black") +
theme_bw()
lm_1 <- lm(TF ~ DBH, data = sub)
lm_1
varpow <- gls(TF ~ DBH, weights = varPower(form = ~ TF), data = sub)
varpow
ggResidpanel::resid_panel(lm_1, plots = c("resid", "qq", "hist"), nrow = 1)
plot(lm_1)
AIC(lm_1, varpow)
AIC(lm_1, varpow)
#Fit a GLS model with the interaction between Species and DBH.
varpow_2 <- gls(TF ~ Species * DBH, weights = varPower(form = ~ Species), data = data_1)
varpow_2
#Identify the optimal variance structure.
# varIdent: different residual variances per Species
gls1 <- gls(TF ~ Species * DBH, data = data_1,
weights = varIdent(form = ~1 | Species))
# varPower: variance depends on fitted values
gls2 <- gls(TF ~ Species * DBH, data = data_1,
weights = varPower(form = ~ fitted(.)))
# varExp: variance increases exponentially with DBH
gls3 <- gls(TF ~ Species * DBH, data = data_1,
weights = varExp(form = ~ DBH))
# varConstPower: flexible power function of DBH
gls4 <- gls(TF ~ Species * DBH, data = data_1,
weights = varConstPower(form = ~ DBH))
#Identify the optimal fixed effects structure (using AIC and nested model comparison).
gls_full <- gls(TF ~ Species * DBH, data = data_1, weights = varIdent(~1|Species))
gls_no_inter <- gls(TF ~ Species + DBH, data = data_1, weights = varIdent(~1|Species))
gls_species <- gls(TF ~ Species, data = data_1, weights = varIdent(~1|Species))
gls_dbh <- gls(TF ~ DBH, data = data_1, weights = varIdent(~1|Species))
# Compare models
AIC(gls_full, gls_no_inter, gls_species, gls_dbh)
anova(gls_full, gls_no_inter)  # Likelihood ratio test for interaction
##Plot the final model and interpret the results.
library(ggplot2)
# Create predicted values
data_1$pred <- predict(gls_full)
ggplot(data_1, aes(x = DBH, y = TF, color = Species)) +
geom_point(alpha = 0.5) +
geom_line(aes(y = pred), size = 1) +
theme_minimal() +
labs(title = "GLS model: TF ~ Species * DBH",
y = "TF",
x = "DBH")
data_2 <- read.csv("Biodiversity.csv")
str(data_2)
library(viridis)
# Convert to factors
data_2$Nutrient <- as.factor(data_2$Nutrient)
data_2$Treatment <- as.factor(data_2$Treatment)
ggplot(data_2, aes(x = interaction(Nutrient, Treatment), y = Concentration, fill = Treatment)) +
geom_boxplot() +
theme_classic()
lm_2 <- lm(Biomass ~ Treatment * Nutrient, data = data_2)
summary(lm_2)
lm_3 <- lm(Biomass ~ Treatment * Nutrient * Concentration, data = data_2)
summary(lm_3)
plot(lm_2)
# Extract residuals from the model
residuals_lm <- residuals(lm_2)
# Base R plots
par(mfrow = c(1,3))  # 3 plots in one row
# 1. Residuals vs Biomass (not typical since Biomass is response, usually vs fitted values)
plot(lm_2$fitted.values, residuals_lm,
xlab = "Fitted Biomass",
ylab = "Residuals",
main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)
# 2. Residuals vs Treatment
plot(data_2$Treatment, residuals_lm,
xlab = "Treatment",
ylab = "Residuals",
main = "Residuals vs Treatment")
# 3. Residuals vs Nutrient
plot(data_2$Nutrient, residuals_lm,
xlab = "Nutrient",
ylab = "Residuals",
main = "Residuals vs Nutrient")
# 1. GLS model accounting for heterogeneity by Treatment
gls_treat <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment)
)
# 2. GLS model accounting for heterogeneity by Nutrient
gls_nutr <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Nutrient)
)
# Make sure factors are properly defined
data_2$Treatment <- as.factor(data_2$Treatment)
data_2$Nutrient <- as.factor(data_2$Nutrient)
# Create an interaction factor
data_2$TreatNutr <- interaction(data_2$Treatment, data_2$Nutrient)
# GLS model with variance by Treatment:Nutrient interaction
gls_inter <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | TreatNutr)
)
# Compare variance structures with likelihood ratio tests
anova(gls_treat, gls_nutr, gls_inter)
#plot residual from model with lowest AIC
plot(gls_treat)
# 1. GLS model accounting for heterogeneity by Treatment
gls_treat <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment)
)
# 2. GLS model accounting for heterogeneity by Nutrient
gls_nutr <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Nutrient)
)
# Make sure factors are properly defined
data_2$Treatment <- as.factor(data_2$Treatment)
data_2$Nutrient <- as.factor(data_2$Nutrient)
# Create an interaction factor
data_2$TreatNutr <- interaction(data_2$Treatment, data_2$Nutrient)
# GLS model with variance by Treatment:Nutrient interaction
gls_inter <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | TreatNutr)
)
# Compare variance structures with likelihood ratio tests
anova(gls_treat, gls_nutr, gls_inter)
#plot residual from model with lowest AIC
plot(gls_treat)
data_3 <- read.csv("Biodiversity.csv")
str(data_3)
# Aggregate by mean Biomass for each unique combination
data_agg <- data_3 %>%
group_by(Abundance, Treatment, Nutrient) %>%
summarise(Biomass_mean = mean(Biomass), .groups = "drop")
data_agg
# Simple linear model
model_simple <- lm(Biomass_mean ~ Abundance + Treatment + Nutrient, data = data_agg)
summary(model_simple)
str(data_3)
data_3$Treatment <- as.factor(data_3$Treatment)
data_3$Nutrient  <- as.factor(data_3$Nutrient)
table(data_3$Treatment)
table(data_3$Nutrient)
library(nlme)
# Fit GLS with main effects only
gls_model <- gls(Biomass ~ Abundance_c + Treatment + Nutrient,
data = data_3,
method = "ML")
str(data_3)
data_3$Treatment <- as.factor(data_3$Treatment)
data_3$Nutrient  <- as.factor(data_3$Nutrient)
table(data_3$Treatment)
table(data_3$Nutrient)
library(nlme)
# Fit GLS with main effects only
gls_model <- gls(Biomass ~ Abundance_c + Treatment + Nutrient,
data = data_3,
method = "REML")
data_3 <- read.csv("Biodiversity.csv")
str(data_3)
data_3$Treatment <- as.factor(data_3$Treatment)
data_3$Nutrient  <- as.factor(data_3$Nutrient)
table(data_3$Treatment)
table(data_3$Nutrient)
data_3 <- read.csv("Biodiversity.csv")
str(data_3)
data_3$Treatment <- as.factor(data_3$Treatment)
data_3$Nutrient  <- as.factor(data_3$Nutrient)
table(data_3$Treatment)
table(data_3$Nutrient)
# Simple linear model
final <- gls(Biomass_mean ~ Abundance + Treatment + Nutrient, data = data_3)
data_3 <- read.csv("Biodiversity.csv")
str(data_3)
data_3$Treatment <- as.factor(data_3$Treatment)
data_3$Nutrient  <- as.factor(data_3$Nutrient)
table(data_3$Treatment)
table(data_3$Nutrient)
# Simple linear model
final <- gls(Biomass ~ Abundance + Treatment + Nutrient, data = data_3)
library(tidyverse)
library(nlme)
library(ggResidpanel)
data_2 <- read.csv("Biodiversity.csv")
str(data_2)
library(tidyverse)
library(nlme)
library(ggResidpanel)
data_2 <- read.csv("Biodiversity.csv")
str(data_2)
library(tidyverse)
library(nlme)
library(ggResidpanel)
anova(gls_inter)
data_2 <- read.csv("Biodiversity.csv")
str(data_2)
library(viridis)
# Convert to factors
data_2$Nutrient <- as.factor(data_2$Nutrient)
data_2$Treatment <- as.factor(data_2$Treatment)
ggplot(data_2, aes(x = interaction(Nutrient, Treatment), y = Concentration, fill = Treatment)) +
geom_boxplot() +
theme_classic()
lm_2 <- lm(Biomass ~ Treatment * Nutrient, data = data_2)
summary(lm_2)
lm_3 <- lm(Biomass ~ Treatment * Nutrient * Concentration, data = data_2)
summary(lm_3)
plot(lm_2)
# Extract residuals from the model
residuals_lm <- residuals(lm_2)
# Base R plots
par(mfrow = c(1,3))  # 3 plots in one row
# 1. Residuals vs Biomass (not typical since Biomass is response, usually vs fitted values)
plot(lm_2$fitted.values, residuals_lm,
xlab = "Fitted Biomass",
ylab = "Residuals",
main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)
# 2. Residuals vs Treatment
plot(data_2$Treatment, residuals_lm,
xlab = "Treatment",
ylab = "Residuals",
main = "Residuals vs Treatment")
# 3. Residuals vs Nutrient
plot(data_2$Nutrient, residuals_lm,
xlab = "Nutrient",
ylab = "Residuals",
main = "Residuals vs Nutrient")
# 1. GLS model accounting for heterogeneity by Treatment
gls_treat <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment)
)
# 2. GLS model accounting for heterogeneity by Nutrient
gls_nutr <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Nutrient)
)
# Make sure factors are properly defined
data_2$Treatment <- as.factor(data_2$Treatment)
data_2$Nutrient <- as.factor(data_2$Nutrient)
# Create an interaction factor
data_2$TreatNutr <- interaction(data_2$Treatment, data_2$Nutrient)
# GLS model with variance by Treatment:Nutrient interaction
gls_inter <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | TreatNutr)
)
# Compare variance structures with likelihood ratio tests
anova(gls_treat, gls_nutr, gls_inter)
#plot residual from model with lowest AIC
plot(gls_treat)
anova(gls_inter)
# 1. GLS model accounting for heterogeneity by Treatment
gls_treat <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment)
)
# 2. GLS model accounting for heterogeneity by Nutrient
gls_nutr <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Nutrient)
)
# Make sure factors are properly defined
data_2$Treatment <- as.factor(data_2$Treatment)
data_2$Nutrient <- as.factor(data_2$Nutrient)
# Create an interaction factor
data_2$TreatNutr <- interaction(data_2$Treatment, data_2$Nutrient)
# GLS model with variance by Treatment:Nutrient interaction
gls_inter <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment:Nutrient)
)
# 1. GLS model accounting for heterogeneity by Treatment
gls_treat <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment)
)
# 2. GLS model accounting for heterogeneity by Nutrient
gls_nutr <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Nutrient)
)
# Make sure factors are properly defined
data_2$Treatment <- as.factor(data_2$Treatment)
data_2$Nutrient <- as.factor(data_2$Nutrient)
# Create an interaction factor
data_2$TreatNutr <- interaction(data_2$Treatment, data_2$Nutrient)
# GLS model with variance by Treatment:Nutrient interaction
gls_inter <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment:Nutrient)
)
# 1. GLS model accounting for heterogeneity by Treatment
gls_treat <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment)
)
# 2. GLS model accounting for heterogeneity by Nutrient
gls_nutr <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Nutrient)
)
# Make sure factors are properly defined
data_2$Treatment <- as.factor(data_2$Treatment)
data_2$Nutrient <- as.factor(data_2$Nutrient)
# Create an interaction factor
data_2$TreatNutr <- interaction(data_2$Treatment, data_2$Nutrient)
# GLS model with variance by Treatment:Nutrient interaction
gls_inter <- gls(
Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | TreatNutr)
)
# Compare variance structures with likelihood ratio tests
anova(gls_treat, gls_nutr, gls_inter)
#plot residual from model with lowest AIC
plot(gls_treat)
# Compare variance structures with likelihood ratio tests
anova(gls_treat, gls_nutr, gls_inter)
#plot residual from model with lowest AIC
plot(gls_treat)
# Extract residuals
resid_df <- data.frame(
fitted = fitted(gls_inter),
residuals = resid(gls_inter, type = "normalized"),
Treatment = data_2$Treatment,
Nutrient = data_2$Nutrient,
TreatNutr = data_2$TreatNutr
)
# Residuals vs Fitted
ggplot(resid_df, aes(x = fitted, y = residuals)) +
geom_point() +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(title = "Residuals vs Fitted", x = "Fitted values", y = "Normalized residuals")
# Residuals by Treatment:Nutrient
ggplot(resid_df, aes(x = TreatNutr, y = residuals)) +
geom_boxplot() +
labs(title = "Residuals by Treatment:Nutrient") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
anova(gls_treat)
# Suppose the 2-way interaction was not significant
final_model <- gls_treat  # or keep gls_full_ML if significant
# Refit with REML for final estimates
gls_final <- gls(formula(final_model),
data = data_2,
weights = varIdent(form = ~1 | Treatment),
method = "REML")
summary(gls_final)
# Compare variance structures with likelihood ratio tests
anova(gls_treat, gls_nutr, gls_inter)
#plot residual from model with lowest AIC
plot(gls_treat)
# Extract residuals
resid_df <- data.frame(
fitted = fitted(gls_treat),
residuals = resid(gls_treat, type = "normalized"),
Treatment = data_2$Treatment,
Nutrient = data_2$Nutrient,
TreatNutr = data_2$TreatNutr
)
resid_df
# Fit full model with ML (required for likelihood ratio tests)
gls_full_ML <- gls(Biomass ~ Treatment * Nutrient * Factor3,
data = data_2,
weights = varIdent(form = ~1 | Treatment),  # best variance structure
method = "ML")
# Fit full model with ML (required for likelihood ratio tests)
gls_full_ML <- gls(Biomass ~ Treatment * Nutrient * TreatNutr,
data = data_2,
weights = varIdent(form = ~1 | Treatment),  # best variance structure
method = "ML")
# Fit full model with ML (required for likelihood ratio tests)
gls_full_ML <- gls(Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment),  # best variance structure
method = "ML")
# Fit full model with ML (required for likelihood ratio tests)
gls_full_ML <- gls(Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment),  # best variance structure
method = "ML")
# Drop 2-way interaction for testing
gls_no_inter <- update(gls_full_ML, . ~ . - Treatment:Nutrient)
anova(gls_full_ML, gls_no_inter)
# Refit final model with REML
gls_final <- gls(formula(gls_no_inter),
data = data_2,
weights = varIdent(form = ~1 | Treatment),
method = "REML")
summary(gls_final)
# Fit full model with ML (required for likelihood ratio tests)
gls_full_ML <- gls(Biomass ~ Treatment * Nutrient,
data = data_2,
weights = varIdent(form = ~1 | Treatment),  # best variance structure
method = "ML")
# Drop 2-way interaction for testing
gls_no_inter <- update(gls_full_ML, . ~ . - Treatment:Nutrient)
anova(gls_full_ML, gls_no_inter)
gls_no_inter
# Refit final model with REML
gls_final <- gls(formula(gls_no_inter),
data = data_2,
weights = varIdent(form = ~1 | Treatment),
method = "REML")
summary(gls_final)
plot(gls_final)
summary(gls_final)
plot(gls_final)
plot(ggpredict(gls_final), show_data=TRUE)
install.packages("ggeffects")
library(tidyverse)
library(nlme)
library(ggResidpanel)
library(ggeffects)
summary(gls_final)
plot(gls_final)
plot(ggpredict(gls_final), show_data=TRUE)
# Standardized residuals
resid_std <- resid(gls_final, type = "normalized")
# Find the index of the largest absolute residual
which.max(abs(resid_std))
# Standardized residuals
resid_std <- resid(gls_final, type = "normalized")
# Find the index of the largest absolute residual
which.max(abs(resid_std))
##take out the outlier
data_no_outlier <- data_2[-which.max(abs(resid_std)), ]
# Standardized residuals
resid_std <- resid(gls_final, type = "normalized")
# Find the index of the largest absolute residual
which.max(abs(resid_std))
##take out the outlier
data_no_outlier <- data_2[-which.max(abs(resid_std)), ]
#Refit the model without the outlier
gls_no_outlier <- gls(Biomass ~ Treatment * Nutrient,
data = data_no_outlier,
weights = varIdent(form = ~1 | Treatment),
method = "REML")
summary(gls_no_outlier)
# Standardized residuals
resid_std <- resid(gls_final, type = "normalized")
# Find the index of the largest absolute residual
which.max(abs(resid_std))
##take out the outlier
data_no_outlier <- data_2[-which.max(abs(resid_std)), ]
#Refit the model without the outlier
gls_no_outlier <- gls(Biomass ~ Treatment * Nutrient,
data = data_no_outlier,
weights = varIdent(form = ~1 | Treatment),
method = "REML")
summary(gls_no_outlier)
#Redo model selection and comparison
gls_reduced <- update(gls_no_outlier, . ~ . - Treatment:Nutrient)
# Compare
anova(gls_no_outlier, gls_reduced)
AIC(gls_no_outlier, gls_reduced)
# Standardized residuals
resid_std <- resid(gls_final, type = "normalized")
# Find the index of the largest absolute residual
which.max(abs(resid_std))
##take out the outlier
data_no_outlier <- data_2[-which.max(abs(resid_std)), ]
#Refit the model without the outlier
gls_no_outlier <- gls(Biomass ~ Treatment * Nutrient,
data = data_no_outlier,
weights = varIdent(form = ~1 | Treatment),
method = "REML")
summary(gls_no_outlier)
#Redo model selection and comparison
gls_reduced <- update(gls_no_outlier, . ~ . - Treatment:Nutrient)
# Compare
anova(gls_no_outlier, gls_reduced)
AIC(gls_no_outlier, gls_reduced)
#plot
plot(ggpredict(gls_no_outlier), show_data=TRUE)
